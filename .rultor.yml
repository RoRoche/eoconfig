---
docker:
  image: yegor256/java
assets:
  settings.xml: roroche/home#assets/eoconfig/settings.xml
  pubring.gpg: roroche/home#assets/pubring.gpg
  secring.gpg: roroche/home#assets/secring.gpg
architect: RoRoche
install: |
  mvn -version
merge:
  script:
    - mvn clean install -DskipTests
  squash: false
  rebase: true
release:
  sensitive:
    - settings.xml
  script: |-
    [[ "${tag}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] || exit -1
    mkdir -p ~/.ssh
    ssh-keyscan github.com >> ~/.ssh/known_hosts
    chmod 700 ~/.ssh
    chmod 600 ~/.ssh/known_hosts
    cp /home/r/settings.xml ./settings.xml
    gpg --import /home/r/pubring.gpg
    gpg --allow-secret-key-import --no-tty --batch --import /home/r/secring.gpg
    echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
    echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
    gpgconf --kill gpg-agent
    mvn versions:set "-DnewVersion=${tag}" -Dstyle.color=never
    git commit -am ":bookmark: ${tag}"
    mvn -B -P release --settings settings.xml clean deploy
    git tag -a "${tag}" -m "Release ${tag}"
    git push --follow-tags origin HEAD
